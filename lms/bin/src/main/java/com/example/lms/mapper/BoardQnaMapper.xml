<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.BoardQnaMapper">

    <select id="selectBoardQnaList" resultType="com.example.lms.dto.BoardQna">
        SELECT
            bq.post_id AS postId,         bq.course_id,
            bq.user_id,
            bq.title,
            bq.content, 
            bq.hit_count AS hitCount,     bq.createdate,
            u.user_name AS userName,      (SELECT COUNT(*) FROM board_qna_comment bqc WHERE bqc.post_id = bq.post_id) AS commentCount
        FROM
            board_qna bq
        JOIN
            users u ON bq.user_id = u.user_id
        WHERE
            bq.course_id = #{courseId}
        
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (
                    bq.title LIKE CONCAT('%', #{searchKeyword}, '%')
                    OR bq.content LIKE CONCAT('%', #{searchKeyword}, '%')
                )
            </if>
        ORDER BY
            bq.createdate DESC
    </select>
    
    <select id="getBoardQnaCount" resultType="int">
        SELECT
            COUNT(*)
        FROM
            board_qna bq
        WHERE
            bq.course_id = #{courseId}
            <if test="searchKeyword != null and searchKeyword != ''">
                AND (
                    bq.title LIKE CONCAT('%', #{searchKeyword}, '%')
                    OR bq.content LIKE CONCAT('%', #{searchKeyword}, '%')
                )
            </if>
    </select>
    
    <select id="findQnaListByCourseId" resultType="com.example.lms.dto.BoardQnaListResponse">
        SELECT
            bq.post_id AS postId,
            bq.course_id,
            bq.title,
            bq.hit_count AS hitCount,
            bq.createdate,
            u.user_name AS userName,
            (SELECT COUNT(*) FROM board_qna_comment bqc WHERE bqc.post_id = bq.post_id) AS commentCount
        FROM
            board_qna bq
        JOIN
            users u ON bq.user_id = u.user_id
        WHERE
            bq.course_id = #{courseId}
        ORDER BY
            bq.createdate DESC
    </select>
    
    <select id="selectBoardQnaDetail" resultType="com.example.lms.dto.BoardQna">
        SELECT
            bq.post_id AS postId,
            bq.course_id,
            bq.user_id,
            bq.title,
            bq.content, 
            bq.hit_count AS hitCount,
            bq.createdate,
            bq.updatedate,
            u.user_name AS userName
        FROM
            board_qna bq
        JOIN
            users u ON bq.user_id = u.user_id
        WHERE
            bq.post_id = #{postId}
    </select>
    
    <insert id="saveQnaPost" parameterType="com.example.lms.dto.BoardQnaWriteRequest" useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO board_qna
            (course_id, user_id, title, content, hit_count, createdate)
        VALUES
            (#{courseId}, #{userId}, #{title}, #{content}, 0, NOW())
    </insert>

    <insert id="insertBoardQna" parameterType="com.example.lms.dto.BoardQna" useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO board_qna
            (course_id, user_id, title, content, hit_count, createdate)
        VALUES
            (#{courseId}, #{userId}, #{title}, #{content}, 0, NOW())
    </insert>

    <update id="updateBoardQna" parameterType="com.example.lms.dto.BoardQna">
        UPDATE board_qna
        SET
            title = #{title},
            content = #{content},
            updatedate = NOW()
        WHERE
            post_id = #{postId}
    </update>

    <delete id="deleteBoardQna" parameterType="Long">
        DELETE FROM board_qna
        WHERE post_id = #{postId}
    </delete>

    <update id="updateHitCount" parameterType="Long">
        UPDATE board_qna
        SET hit_count = hit_count + 1
        WHERE post_id = #{postId}
    </update>
</mapper>