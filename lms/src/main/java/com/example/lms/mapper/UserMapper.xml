<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.UserMapper">

    <!-- 공통으로 쓸 ResultMap -->
    <resultMap id="userResultMap" type="com.example.lms.dto.User">
	    <id     property="userId"       column="user_id"/>
	
	    <result property="loginId"      column="login_id"/>
	    <result property="password"     column="password"/>
	    <result property="role"         column="role"/>
	
	    <result property="studentNo"    column="student_no"/>
	    <result property="employeeNo"   column="employee_no"/>
	
	    <result property="userName"     column="user_name"/>
	    <result property="gender"       column="gender"/>
	    <result property="userGrade"    column="user_grade"/>
	
	    <result property="phone"        column="phone"/>
	    <result property="email"        column="email"/>
	
	    <result property="zipCode"      column="zip_code"/>
	    <result property="address1"     column="address1"/>
	    <result property="address2"     column="address2"/>
	
	    <result property="status"       column="status"/>
	
	    <result property="createdate"   column="createdate"/>
	    <result property="updatedate"   column="updatedate"/>
	
	    <result property="departmentId"   column="department_id"/>
	    <result property="departmentName" column="department_name"/> <!-- ★ 추가 -->
	</resultMap>


    <!-- 로그인  -->
    <select id="login" parameterType="com.example.lms.dto.User"
        	resultMap="userResultMap">
	    SELECT
	        u.user_id,
	        u.login_id,
	        u.password,
	        u.role,
	        u.student_no,
	        u.employee_no,
	        u.user_name,
	        u.gender,
	        u.user_grade,
	        u.phone,
	        u.email,
	        u.zip_code,
	        u.address1,
	        u.address2,
	        u.status,
	        u.createdate,
	        u.updatedate,
	        u.department_id,
	        d.department_name
	    FROM users u
	    LEFT JOIN department d ON u.department_id = d.department_id
	    WHERE u.login_id = #{loginId}
	      AND u.password = #{password}
	</select>

    <!-- 마이페이지: 내 정보 조회 (user_id 기준 단건) -->
    <select id="selectUserById" parameterType="long"
            resultMap="userResultMap">
        SELECT
	        u.user_id,
	        u.login_id,
	        u.password,
	        u.role,
	        u.student_no,
	        u.employee_no,
	        u.user_name,
	        u.gender,
	        u.user_grade,
	        u.phone,
	        u.email,
	        u.zip_code,
	        u.address1,
	        u.address2,
	        u.status,
	        u.createdate,
	        u.updatedate,
	        u.department_id,
	        d.department_name
	    FROM users u
	    LEFT JOIN department d ON u.department_id = d.department_id
	    WHERE u.user_id = #{userId}
    </select>

    <!-- 마이페이지: 내 정보 수정 -->
    <update id="updateUserInfo" parameterType="com.example.lms.dto.User">
        UPDATE users
        <set>
            user_name = #{userName},
            phone     = #{phone},
            email     = #{email},
            <if test="zipCode != null">
                zip_code = #{zipCode},
            </if>
            <if test="address1 != null">
                address1 = #{address1},
            </if>
            <if test="address2 != null">
                address2 = #{address2},
            </if>
            <if test="departmentId != null">
                department_id = #{departmentId},
            </if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <!-- 비밀번호 변경 (현재 비밀번호가 맞을 때만 변경) -->
    <update id="updateUserPassword">
        UPDATE users
        SET password = #{newPassword}
        WHERE user_id  = #{userId}
          AND password = #{currentPassword}
    </update>

	<!-- 회원가입 -->
    <insert id="insertUser" parameterType="com.example.lms.dto.User">
        INSERT INTO users (
            login_id,
            password,
            role,
            student_no,
            employee_no,
            user_name,
            gender,
            user_grade,
            phone,
            email,
            zip_code,
            address1,
            address2,
            status,
            department_id
        ) VALUES (
            #{loginId},
            #{password},
            #{role},
            #{studentNo},
            #{employeeNo},
            #{userName},
            #{gender},
            #{userGrade},
            #{phone},
            #{email},
            #{zipCode},
            #{address1},
            #{address2},
            #{status},
            #{departmentId}
        )
    </insert>
    
    <!-- 아이디 찾기 -->
    <select id="findLoginIdByNameAndEmail"
            resultType="string">
        SELECT login_id
        FROM users
        WHERE user_name = #{userName}
          AND email = #{email}
    </select>
    
    <!-- 비밀번호 찾기: 사용자 존재 여부 확인 -->
    <select id="findUserIdForPasswordReset"
            resultType="java.lang.Integer">
        SELECT user_id
        FROM users
        WHERE login_id = #{loginId}
          AND user_name = #{userName}
          AND email = #{email}
    </select>

    <!-- 비밀번호 업데이트 -->
    <update id="updatePassword">
        UPDATE users
        SET password = #{password}
        WHERE login_id = #{loginId}
    </update>
    
    <!-- 전체 사용자 목록 (알림용) -->
	<select id="selectAllUsers" resultType="com.example.lms.dto.User">
	    SELECT 
	        user_id AS userId,
	        login_id AS loginId,
	        user_name AS userName,
	        role
	    FROM users
	    WHERE status = 'ACTIVE'
	</select>
    
</mapper>
