<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.UserMapper">

    <resultMap id="userResultMap" type="com.example.lms.dto.User">
	    <id     property="userId"       column="user_id"/>
	
	    <result property="loginId"      column="login_id"/>
	    <result property="password"     column="password"/>
	    <result property="role"         column="role"/>
	
	    <result property="studentNo"    column="student_no"/>
	    <result property="employeeNo"   column="employee_no"/>
	
	    <result property="userName"     column="user_name"/>
	    <result property="gender"       column="gender"/>
	    <result property="userGrade"    column="user_grade"/>
	
	    <result property="phone"        column="phone"/>
	    <result property="email"        column="email"/>
	
	    <result property="zipCode"      column="zip_code"/>
	    <result property="address1"     column="address1"/>
	    <result property="address2"     column="address2"/>
	
	    <result property="status"       column="status"/>
	
	    <result property="createdate"   column="createdate"/>
	    <result property="updatedate"   column="updatedate"/>
	
	    <result property="departmentId"   column="department_id"/>
	    <result property="departmentName" column="department_name"/> </resultMap>


    <select id="login" parameterType="com.example.lms.dto.User"
        	resultMap="userResultMap">
	    SELECT
	        u.user_id,
	        u.login_id,
	        u.password,
	        u.role,
	        u.student_no,
	        u.employee_no,
	        u.user_name,
	        u.gender,
	        u.user_grade,
	        u.phone,
	        u.email,
	        u.zip_code,
	        u.address1,
	        u.address2,
	        u.status,
	        u.createdate,
	        u.updatedate,
	        u.department_id,
	        d.department_name
	    FROM users u
	    LEFT JOIN department d ON u.department_id = d.department_id
	    WHERE u.login_id = #{loginId}
	      AND u.password = #{password}
	</select>

    <select id="selectUserById" parameterType="long"
            resultMap="userResultMap">
        SELECT
	        u.user_id,
	        u.login_id,
	        u.password,
	        u.role,
	        u.student_no,
	        u.employee_no,
	        u.user_name,
	        u.gender,
	        u.user_grade,
	        u.phone,
	        u.email,
	        u.zip_code,
	        u.address1,
	        u.address2,
	        u.status,
	        u.createdate,
	        u.updatedate,
	        u.department_id,
	        d.department_name
	    FROM users u
	    LEFT JOIN department d ON u.department_id = d.department_id
	    WHERE u.user_id = #{userId}
    </select>

    <update id="updateUserInfo" parameterType="com.example.lms.dto.User">
        UPDATE users
        <set>
            user_name = #{userName},
            phone     = #{phone},
            email     = #{email},
            <if test="zipCode != null">
                zip_code = #{zipCode},
            </if>
            <if test="address1 != null">
                address1 = #{address1},
            </if>
            <if test="address2 != null">
                address2 = #{address2},
            </if>
            <if test="departmentId != null">
                department_id = #{departmentId},
            </if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <update id="updateUserPassword">
        UPDATE users
        SET password = #{newPassword}
        WHERE user_id  = #{userId}
          AND password = #{currentPassword}
    </update>

	<insert id="insertUser" parameterType="com.example.lms.dto.User">
        INSERT INTO users (
            login_id,
            password,
            role,
            student_no,
            employee_no,
            user_name,
            gender,
            user_grade,
            phone,
            email,
            zip_code,
            address1,
            address2,
            status,
            department_id
        ) VALUES (
            #{loginId},
            #{password},
            #{role},
            #{studentNo},
            #{employeeNo},
            #{userName},
            #{gender},
            #{userGrade},
            #{phone},
            #{email},
            #{zipCode},
            #{address1},
            #{address2},
            #{status},
            #{departmentId}
        )
    </insert>
    
    <select id="findLoginIdByNameAndEmail"
            resultType="string">
        SELECT login_id
        FROM users
        WHERE user_name = #{userName}
          AND email = #{email}
    </select>
    
    <select id="findUserIdForPasswordReset"
            resultType="java.lang.Integer">
        SELECT user_id
        FROM users
        WHERE login_id = #{loginId}
          AND user_name = #{userName}
          AND email = #{email}
    </select>

    <update id="updatePassword">
        UPDATE users
        SET password = #{password}
        WHERE login_id = #{loginId}
    </update>
    
    <select id="selectAllUsers" resultType="com.example.lms.dto.User">
	    SELECT 
	        user_id AS userId,
	        login_id AS loginId,
	        user_name AS userName,
	        role
	    FROM users
	    WHERE status = 'ACTIVE'
	</select>
    
    
    <select id="selectUsersWithPagingAndSearch" resultMap="userResultMap">
        SELECT
            u.user_id,
            u.login_id,
            u.role,
            u.user_name,
            u.email,
            u.status,
            u.createdate,
            d.department_name
        FROM users u
        LEFT JOIN department d ON u.department_id = d.department_id
        <where>
            <if test="searchKeyword != null and searchKeyword != '' and searchType != null and searchType != ''">
                <choose>
                    <when test="searchType == 'userName'">
                        AND u.user_name LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'loginId'">
                        AND u.login_id LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'role'">
                        AND u.role LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'departmentName'">
                        AND d.department_name LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY u.createdate DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="countUsersWithSearch" resultType="int">
        SELECT COUNT(u.user_id)
        FROM users u
        LEFT JOIN department d ON u.department_id = d.department_id
        <where>
            <if test="searchKeyword != null and searchKeyword != '' and searchType != null and searchType != ''">
                <choose>
                    <when test="searchType == 'userName'">
                        AND u.user_name LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'loginId'">
                        AND u.login_id LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'role'">
                        AND u.role LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'departmentName'">
                        AND d.department_name LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>
</mapper>
